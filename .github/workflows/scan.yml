name: Upload Configs to Yandex Disk

on:
  schedule:
    - cron: '0 */6 * * *'  # Her 6 saatte bir Ã§alÄ±ÅŸÄ±r
  workflow_dispatch:  # Manuel tetikleme iÃ§in

jobs:
  upload:
    runs-on: ubuntu-latest
    
    steps:
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install aiohttp
      
      - name: Create upload script
        run: |
          cat > github_action_simple.py << 'SCRIPT_EOF'
          #!/usr/bin/env python3
          """
          GitHub Action Script - Multi-URL to Yandex Disk
          Birden fazla link'ten config Ã§eker ve Yandex Disk'e yÃ¼kler
          """

          import os
          import sys
          import asyncio
          import aiohttp

          sys.stdout.reconfigure(encoding='utf-8')

          # Ayarlar - GitHub Secrets'tan alÄ±nÄ±r
          CONFIG_URLS = os.getenv("CONFIG_URLS")
          YANDEX_TOKEN = os.getenv("YANDEX_TOKEN")
          YANDEX_OUTPUT_FILE = os.getenv("YANDEX_OUTPUT_FILE", "/working_configs.txt")
          YANDEX_API_BASE = "https://cloud-api.yandex.net/v1/disk"

          async def fetch_configs_from_url(session, url, url_index):
              """Tek bir URL'den configleri Ã§ek"""
              try:
                  print(f"[-] [{url_index}] URL Ã§ekiliyor: {url}")
                  
                  async with session.get(url.strip(), timeout=aiohttp.ClientTimeout(total=30)) as resp:
                      if resp.status != 200:
                          print(f"[!] [{url_index}] HTTP HatasÄ±: {resp.status}")
                          return []
                      
                      raw_data = await resp.text()
                      configs = [line.strip() for line in raw_data.splitlines() if line.strip() and "://" in line]
                      
                      print(f"[+] [{url_index}] {len(configs)} config bulundu")
                      return configs
              
              except asyncio.TimeoutError:
                  print(f"[!] [{url_index}] Timeout: {url}")
                  return []
              except Exception as e:
                  print(f"[!] [{url_index}] Hata: {e}")
                  return []

          async def fetch_all_configs():
              """TÃ¼m URL'lerden configleri Ã§ek"""
              if not CONFIG_URLS:
                  print("[!] HATA: CONFIG_URLS tanÄ±mlanmamÄ±ÅŸ!")
                  return None
              
              # URL listesini ayÄ±r
              url_list = []
              for separator in [',', ';', '\n']:
                  if separator in CONFIG_URLS:
                      url_list = [u.strip() for u in CONFIG_URLS.split(separator) if u.strip()]
                      break
              
              if not url_list:
                  url_list = [CONFIG_URLS.strip()]
              
              print("=" * 60)
              print(f"ðŸ“‹ Toplam {len(url_list)} URL bulundu")
              print("=" * 60)
              
              all_configs = []
              
              async with aiohttp.ClientSession() as session:
                  tasks = [fetch_configs_from_url(session, url, i+1) for i, url in enumerate(url_list)]
                  results = await asyncio.gather(*tasks)
                  
                  for configs in results:
                      all_configs.extend(configs)
              
              unique_configs = list(set(all_configs))
              
              print("=" * 60)
              print(f"[+] Toplam: {len(all_configs)} config")
              print(f"[+] Benzersiz: {len(unique_configs)} config")
              print(f"[+] Duplikat: {len(all_configs) - len(unique_configs)} config temizlendi")
              print("=" * 60)
              
              return unique_configs

          async def yandex_disk_upload(content):
              """Yandex Disk'e dosya yÃ¼kle"""
              if not YANDEX_TOKEN:
                  print("[!] HATA: YANDEX_TOKEN tanÄ±mlanmamÄ±ÅŸ!")
                  return False
              
              try:
                  headers = {"Authorization": f"OAuth {YANDEX_TOKEN}"}
                  
                  async with aiohttp.ClientSession() as session:
                      print(f"[-] Yandex Disk'e yÃ¼kleniyor: {YANDEX_OUTPUT_FILE}")
                      
                      async with session.get(
                          f"{YANDEX_API_BASE}/resources/upload",
                          params={"path": YANDEX_OUTPUT_FILE, "overwrite": "true"},
                          headers=headers,
                          timeout=aiohttp.ClientTimeout(total=30)
                      ) as resp:
                          if resp.status != 200:
                              print(f"[!] âŒ Yandex API hatasÄ±: {resp.status}")
                              error_text = await resp.text()
                              print(f"[!] YanÄ±t: {error_text}")
                              return False
                          
                          data = await resp.json()
                          upload_url = data.get("href")
                          
                          if not upload_url:
                              print("[!] âŒ Upload URL alÄ±namadÄ±")
                              return False
                      
                      async with session.put(
                          upload_url,
                          data=content.encode('utf-8'),
                          timeout=aiohttp.ClientTimeout(total=60)
                      ) as resp:
                          if resp.status in [201, 202]:
                              print(f"[+] âœ… BaÅŸarÄ±lÄ±: {YANDEX_OUTPUT_FILE} Yandex Disk'e yÃ¼klendi")
                              print(f"[+] ðŸ“Š Dosya boyutu: {len(content)} byte")
                              return True
                          else:
                              print(f"[!] âŒ Yandex upload hatasÄ±: {resp.status}")
                              error_text = await resp.text()
                              print(f"[!] YanÄ±t: {error_text}")
                              return False
              
              except Exception as e:
                  print(f"[!] Upload hatasÄ±: {e}")
                  return False

          async def main():
              """Ana program akÄ±ÅŸÄ±"""
              print("=" * 60)
              print("GitHub Action - Multi-URL to Yandex Disk")
              print("=" * 60)
              
              if not CONFIG_URLS or not YANDEX_TOKEN:
                  print("[!] HATA: CONFIG_URLS veya YANDEX_TOKEN secrets eksik!")
                  sys.exit(1)
              
              configs = await fetch_all_configs()
              
              if not configs:
                  print("[!] HiÃ§bir config bulunamadÄ±")
                  sys.exit(1)
              
              content = "\n".join(configs)
              success = await yandex_disk_upload(content)
              
              if success:
                  print("=" * 60)
                  print(f"[+] âœ… Ä°ÅŸlem tamamlandÄ±: {len(configs)} config yÃ¼klendi")
                  print("=" * 60)
                  sys.exit(0)
              else:
                  print("[!] âŒ YÃ¼kleme baÅŸarÄ±sÄ±z!")
                  sys.exit(1)

          if __name__ == "__main__":
              asyncio.run(main())
          SCRIPT_EOF
          
          chmod +x github_action_simple.py
      
      - name: Upload configs to Yandex Disk
        env:
          CONFIG_URLS: ${{ secrets.CONFIG_URLS }}
          YANDEX_TOKEN: ${{ secrets.YANDEX_TOKEN }}
          YANDEX_OUTPUT_FILE: ${{ secrets.YANDEX_OUTPUT_FILE || '/working_configs.txt' }}
        run: |
          python scanner.py
      
      - name: Upload logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: error-logs
          path: |
            *.log
            *.txt
